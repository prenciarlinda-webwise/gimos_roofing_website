server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(self), interest-cohort=()" always;
    add_header X-DNS-Prefetch-Control "on" always;
    # Note: Strict-Transport-Security should be set at the load balancer/proxy level
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Redirects for old URLs
    rewrite ^/about-us$ /about permanent;
    rewrite ^/contact-us$ /contact permanent;
    rewrite ^/roofing-services$ /services permanent;
    rewrite ^/siding-services$ /services permanent;
    rewrite ^/roofing-and-siding-services-in-jacksonville-beach$ /roofing-jacksonville-beach-fl permanent;
    rewrite ^/sitemap_index.xml$ /sitemap.xml permanent;
    rewrite ^/roofing-st\.-augustine-fl$ /roofing-st-augustine-fl permanent;

    # Old blog post redirects
    rewrite ^/why-quality-roofing-matters-in-jacksonville-fl-trust-gimos-roofing-for-your-home$ /blog permanent;
    rewrite ^/protect-your-home-why-choosing-professional-roofing-services-matters$ /blog permanent;
    rewrite ^/signs-you-need-roof-repair-jacksonville$ /blog permanent;

    # SEO optimized redirects - removing cannibalized/irrelevant content
    rewrite ^/blog/when-roof-needs-replacement$ /blog/roof-repair-vs-replacement-jacksonville permanent;
    rewrite ^/blog/flat-roof-repair-jacksonville$ /blog permanent;

    # Cache static assets - 1 year for immutable assets
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Cache JS and CSS with content hash in filename - 1 year
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Cache HTML pages - shorter cache for dynamic content updates
    location ~* \.html$ {
        expires 1h;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Handle static site routing - try exact file, then directory, then .html extension
    location / {
        try_files $uri $uri/ $uri.html =404;
    }

    # Custom 404 page
    error_page 404 /404.html;
}
